FROM golang:1.26-alpine

RUN apk add --no-cache git gcc musl-dev jq bash

WORKDIR /app

# Cache dependencies
COPY go.mod go.sum ./
RUN go mod download

# Copy source
COPY . .

# Default: run tests with race detector
CMD ["go", "test", "./internal/...", "-race", "-count=1", "-coverprofile=/tmp/coverage.out"]
